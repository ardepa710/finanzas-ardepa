generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum TipoCredito {
  PRESTAMO
  TARJETA
}

enum FrecuenciaPago {
  SEMANAL
  QUINCENAL
  MENSUAL
}

enum TipoCategoria {
  GASTO
  INGRESO
}

enum FuenteGasto {
  TELEGRAM
  WEB
}

enum PeriodoPresupuesto {
  SEMANAL
  QUINCENAL
  MENSUAL
}

model Categoria {
  id          String        @id @default(cuid())
  nombre      String
  icono       String
  color       String
  tipo        TipoCategoria
  activa      Boolean       @default(true)
  orden       Int

  parentId    String?
  parent      Categoria?    @relation("SubCategorias", fields: [parentId], references: [id])
  hijos       Categoria[]   @relation("SubCategorias")

  gastos       Gasto[]
  gastosFijos  GastoFijo[]
  presupuestos Presupuesto[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([nombre, tipo])
  @@index([activa])
}

model Credito {
  id          String         @id @default(cuid())
  nombre      String
  tipo        TipoCredito
  montoTotal  Decimal        @db.Decimal(10, 2)
  saldoActual Decimal        @db.Decimal(10, 2)
  pagoMensual Decimal        @db.Decimal(10, 2)
  pagoMinimo  Decimal?       @db.Decimal(10, 2)
  fechaCorte  Int?
  diaPago     Int
  tasaInteres Decimal?       @db.Decimal(5, 2)
  activo      Boolean        @default(true)
  frecuencia  FrecuenciaPago @default(MENSUAL)
  diaSemana   Int?
  fechaBase   DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([activo])
}

model Gasto {
  id          String      @id @default(cuid())
  descripcion String
  monto       Decimal     @db.Decimal(10, 2)
  categoriaId String
  categoria   Categoria   @relation(fields: [categoriaId], references: [id])
  fecha       DateTime    @default(now())
  fuente      FuenteGasto @default(WEB)
  createdAt   DateTime    @default(now())

  @@index([categoriaId, fecha])
}

model FuenteIngreso {
  id         String         @id @default(cuid())
  nombre     String
  monto      Decimal        @db.Decimal(10, 2)
  frecuencia FrecuenciaPago
  diaSemana  Int?
  diaMes     Int?
  fechaBase  DateTime
  activo     Boolean        @default(true)
  createdAt  DateTime       @default(now())
  ingresos   IngresoManual[]

  @@index([activo])
}

model IngresoManual {
  id          String         @id @default(cuid())
  monto       Decimal        @db.Decimal(10, 2)
  fecha       DateTime       @default(now())
  descripcion String?
  fuenteId    String?
  fuente      FuenteIngreso? @relation(fields: [fuenteId], references: [id])
  createdAt   DateTime       @default(now())

  @@index([fuenteId])
  @@index([fecha])
}

model GastoFijo {
  id          String         @id @default(cuid())
  nombre      String
  monto       Decimal        @db.Decimal(10, 2)
  categoriaId String
  categoria   Categoria      @relation(fields: [categoriaId], references: [id])
  frecuencia  FrecuenciaPago
  diaSemana   Int?
  diaMes      Int?
  fechaBase   DateTime
  activo      Boolean        @default(true)
  lastApplied DateTime?
  createdAt   DateTime       @default(now())

  @@index([activo])
  @@index([categoriaId])
}

model Presupuesto {
  id           String              @id @default(cuid())
  categoriaId  String
  categoria    Categoria           @relation(fields: [categoriaId], references: [id])

  monto        Decimal             @db.Decimal(10, 2)
  periodo      PeriodoPresupuesto

  alertaEn80   Boolean             @default(true)
  alertaEn90   Boolean             @default(true)
  alertaEn100  Boolean             @default(true)

  activo       Boolean             @default(true)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@unique([categoriaId, periodo])
  @@index([activo])
}

model Notificacion {
  id          String   @id @default(cuid())
  tipo        TipoNotificacion
  titulo      String
  mensaje     String   @db.Text
  prioridad   Prioridad @default(NORMAL)

  metadata    Json?

  leida       Boolean  @default(false)
  archivar    Boolean  @default(false)

  createdAt   DateTime @default(now())

  @@index([leida, createdAt])
  @@index([tipo])
}

enum TipoNotificacion {
  PRESUPUESTO_80
  PRESUPUESTO_90
  PRESUPUESTO_100
  CREDITO_PROXIMO
  CREDITO_VENCIDO
  AHORRO_BAJO
  AHORRO_META
  GASTO_INUSUAL
  LOGRO_DESBLOQUEADO
  INSIGHT_IA
}

enum Prioridad {
  BAJA
  NORMAL
  ALTA
  URGENTE
}

enum TipoActivo {
  INMUEBLE
  VEHICULO
  INVERSION
  AHORRO
  EFECTIVO
  OTRO
}

enum Liquidez {
  ALTA
  MEDIA
  BAJA
}

model Activo {
  id                String      @id @default(cuid())
  nombre            String
  tipo              TipoActivo
  valorActual       Decimal     @db.Decimal(12, 2)
  valorCompra       Decimal?    @db.Decimal(12, 2)
  fechaAdquisicion  DateTime?
  descripcion       String?     @db.Text
  liquidez          Liquidez    @default(MEDIA)
  activo            Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  historico         ValoracionActivo[]
  inversiones       Inversion[]

  @@index([activo])
  @@index([tipo])
}

model ValoracionActivo {
  id        String   @id @default(cuid())
  activoId  String
  activo    Activo   @relation(fields: [activoId], references: [id], onDelete: Cascade)
  valor     Decimal  @db.Decimal(12, 2)
  fecha     DateTime
  notas     String?  @db.Text
  createdAt DateTime @default(now())

  @@index([activoId, fecha])
}

enum TipoTransaccion {
  COMPRA
  VENTA
  DIVIDENDO
  INTERES
  RETIRO
  APORTE
}

model Inversion {
  id                String                 @id @default(cuid())
  activoId          String
  activo            Activo                 @relation(fields: [activoId], references: [id])

  // Investment details
  montoInvertido    Decimal                @db.Decimal(12, 2)
  fechaInversion    DateTime

  // Performance tracking
  valorActual       Decimal                @db.Decimal(12, 2)
  rendimientoTotal  Decimal                @db.Decimal(12, 2)  // valorActual - montoInvertido
  rendimientoPct    Decimal                @db.Decimal(5, 2)   // (rendimientoTotal / montoInvertido) * 100

  // Returns
  dividendos        Decimal                @default(0) @db.Decimal(12, 2)
  intereses         Decimal                @default(0) @db.Decimal(12, 2)

  // Metadata
  descripcion       String?                @db.Text
  activa            Boolean                @default(true)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  transacciones     TransaccionInversion[]

  @@index([activoId])
  @@index([activa])
}

model TransaccionInversion {
  id              String           @id @default(cuid())
  inversionId     String
  inversion       Inversion        @relation(fields: [inversionId], references: [id], onDelete: Cascade)

  tipo            TipoTransaccion
  monto           Decimal          @db.Decimal(12, 2)
  fecha           DateTime
  descripcion     String?          @db.Text

  createdAt       DateTime         @default(now())

  @@index([inversionId])
  @@index([tipo])
  @@index([fecha])
}

enum CategoriaMeta {
  FONDO_EMERGENCIA
  VACACIONES
  ENGANCHE_CASA
  ENGANCHE_AUTO
  EDUCACION
  RETIRO
  DEUDA
  COMPRA_GRANDE
  OTRO
}

enum EstadoMeta {
  EN_PROGRESO
  COMPLETADA
  CANCELADA
  PAUSADA
}

enum PrioridadMeta {
  ALTA
  MEDIA
  BAJA
}

model Meta {
  id                String              @id @default(cuid())

  // Goal details
  nombre            String
  descripcion       String?             @db.Text
  categoria         CategoriaMeta

  // Financial targets
  montoObjetivo     Decimal             @db.Decimal(12, 2)
  montoActual       Decimal             @default(0) @db.Decimal(12, 2)
  porcentajeProgreso Decimal            @default(0) @db.Decimal(5, 2)  // Auto-calculated

  // Timeline
  fechaInicio       DateTime            @default(now())
  fechaObjetivo     DateTime?
  fechaCompletada   DateTime?

  // Status
  estado            EstadoMeta          @default(EN_PROGRESO)
  prioridad         PrioridadMeta       @default(MEDIA)

  // Metadata
  activo            Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  contribuciones    Contribucion[]

  @@index([estado])
  @@index([activo])
  @@index([categoria])
}

model Contribucion {
  id          String      @id @default(cuid())
  metaId      String
  meta        Meta        @relation(fields: [metaId], references: [id], onDelete: Cascade)

  monto       Decimal     @db.Decimal(12, 2)
  fecha       DateTime    @default(now())
  descripcion String?     @db.Text

  createdAt   DateTime    @default(now())

  @@index([metaId])
  @@index([fecha])
}

enum TipoInsight {
  GASTOS
  INGRESOS
  DEUDA
  AHORRO
  INVERSION
  PRESUPUESTO
  GENERAL
}

model Insight {
  id          String      @id @default(cuid())

  tipo        TipoInsight
  titulo      String
  contenido   String      @db.Text
  prioridad   Prioridad   @default(NORMAL)

  // AI metadata
  modelo      String      @default("claude-haiku-4-5-20251001")
  tokens      Int?

  // User interaction
  leido       Boolean     @default(false)
  util        Boolean?    // User feedback: was this helpful?

  createdAt   DateTime    @default(now())

  @@index([tipo])
  @@index([leido])
  @@index([createdAt])
}
